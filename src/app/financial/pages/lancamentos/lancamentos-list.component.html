<div>
  <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <h2 class="text-title-md2 font-semibold text-black dark:text-white flex flex-col sm:flex-row sm:items-center gap-2">
      <span *ngIf="selectedStore">{{ selectedStore.name }}</span>
      <span *ngIf="selectedStore" class="hidden sm:inline text-gray-400 font-normal">|</span>
      <span [class.text-lg]="selectedStore" [class.text-gray-500]="selectedStore" [class.font-normal]="selectedStore">
        {{ 'financial.transactions.title' | translate }}
      </span>
    </h2>
    <div class="flex items-center gap-4">
      <button
        (click)="toggleForm()"
        class="inline-flex items-center justify-center gap-2 rounded-lg bg-brand-500 px-4 py-2 text-sm font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-4 focus:ring-brand-500/50"
      >
        <svg
          *ngIf="!isFormVisible"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <svg
          *ngIf="isFormVisible"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        {{ isFormVisible ? ('financial.transactions.actions.cancel' | translate) : ('financial.transactions.actions.new' | translate) }}
      </button>
    </div>
  </div>

  <!-- Overview Card -->
  <div class="mb-6 rounded-2xl border border-gray-200 bg-white p-4 sm:p-6 dark:border-gray-800 dark:bg-white/[0.03]" *ngIf="!isFormVisible">
    <div class="mb-6 flex items-center justify-between">
      <div>
        <h2 class="font-semibold text-gray-800 dark:text-white/90">
          {{ 'financial.transactions.overview.title' | translate }}
        </h2>
      </div>
    </div>
    <div class="grid grid-cols-1 rounded-xl border border-gray-200 sm:grid-cols-2 lg:grid-cols-4 lg:divide-x lg:divide-y-0 dark:divide-gray-800 dark:border-gray-800">
      <div class="border-b p-5 sm:border-r lg:border-b-0">
        <p class="mb-1.5 text-sm text-gray-400 dark:text-gray-500">
          {{ 'financial.transactions.overview.toPay' | translate }}
        </p>
        <h3 class="text-3xl text-gray-800 dark:text-white/90">{{ totalPayablePending | currency:'BRL' }}</h3>
      </div>
      <div class="border-b p-5 lg:border-b-0">
        <p class="mb-1.5 text-sm text-gray-400 dark:text-gray-500">
          {{ 'financial.transactions.overview.toReceive' | translate }}
        </p>
        <h3 class="text-3xl text-gray-800 dark:text-white/90">{{ totalReceivablePending | currency:'BRL' }}</h3>
      </div>
      <div class="border-b p-5 sm:border-r sm:border-b-0">
        <p class="mb-1.5 text-sm text-gray-400 dark:text-gray-500">
          {{ 'financial.transactions.overview.paid' | translate }}
        </p>
        <h3 class="text-3xl text-gray-800 dark:text-white/90">{{ totalPayablePaid | currency:'BRL' }}</h3>
      </div>
      <div class="p-5">
        <p class="mb-1.5 text-sm text-gray-400 dark:text-gray-500">
          {{ 'financial.transactions.overview.received' | translate }}
        </p>
        <h3 class="text-3xl text-gray-800 dark:text-white/90">
          {{ totalReceivablePaid | currency:'BRL' }}
        </h3>
      </div>
    </div>
  </div>

  <!-- Cards superiores: Formulário e Upload -->
  <div class="mt-5 mb-6 grid grid-cols-1 gap-6 lg:grid-cols-3" *ngIf="isFormVisible">
    <!-- Card do formulário -->
    <div class="rounded-xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] lg:col-span-2">
      <h3 class="mb-4 text-lg font-semibold text-gray-800 dark:text-white/90">
        <ng-container [ngSwitch]="formMode">
          <span
            *ngSwitchCase="'pay'"
            class="inline-block rounded-r-full bg-green-500 px-4 py-1.5 text-sm font-semibold text-white dark:bg-green-600"
          >
            {{ 'financial.transactions.actions.payTitle' | translate }}
          </span>
          <span
            *ngSwitchCase="'edit'"
            class="inline-block rounded-r-full bg-blue-500 px-4 py-1.5 text-sm font-semibold text-white dark:bg-blue-600"
          >
            {{ 'financial.transactions.actions.editTitle' | translate }}
          </span>
          <span
            *ngSwitchCase="'cancel'"
            class="inline-block rounded-r-full bg-red-500 px-4 py-1.5 text-sm font-semibold text-white dark:bg-red-600"
          >
            {{ 'financial.transactions.actions.cancelTitle' | translate }}
          </span>
          <span
            *ngSwitchDefault
            class="inline-block rounded-r-full bg-brand-500 px-4 py-1.5 text-sm font-semibold text-white dark:bg-brand-600"
          >
            {{ 'financial.transactions.actions.newTitle' | translate }}
          </span>
        </ng-container>
      </h3>
      <form [formGroup]="transactionForm" (ngSubmit)="saveTransaction()">
        <div class="grid grid-cols-1 gap-4 md:grid-cols-6 items-end">
          <div class="md:col-span-2">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.type' | translate }}
            </label>
            <div class="relative z-20 bg-transparent">
              <select formControlName="type" class="w-full py-2 pl-3 pr-8 text-sm text-gray-800 bg-transparent border border-gray-300 rounded-lg appearance-none h-11 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
                <option *ngFor="let t of transactionTypes" [value]="t.value">{{ t.labelKey | translate }}</option>
              </select>
              <span class="absolute z-30 text-gray-500 -translate-y-1/2 right-2 top-1/2 dark:text-gray-400">
                 <svg class="stroke-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" /></svg>
              </span>
            </div>
          </div>

          <div class="md:col-span-2" *ngIf="transactionForm.get('type')?.value === 'PAYABLE' || transactionForm.get('type')?.value === 'RECEIVABLE'">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{
                transactionForm.get('type')?.value === 'PAYABLE'
                  ? ('financial.transactions.form.fields.supplier' | translate)
                  : ('financial.transactions.form.fields.customer' | translate)
              }}
            </label>
            <div class="relative z-20 bg-transparent">
              <select formControlName="party_id" class="w-full py-2 pl-3 pr-8 text-sm text-gray-800 bg-transparent border border-gray-300 rounded-lg appearance-none h-11 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
                <option value="">{{ 'financial.transactions.form.placeholders.select' | translate }}</option>
                <option *ngFor="let e of entities" [value]="e.id">{{ e.name }}</option>
              </select>
              <span class="absolute z-30 text-gray-500 -translate-y-1/2 right-2 top-1/2 dark:text-gray-400">
                 <svg class="stroke-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" /></svg>
              </span>
            </div>
          </div>

          <div class="md:col-span-2">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.nf' | translate }}
            </label>
            <input
              type="text"
              formControlName="nf"
              [readonly]="formMode === 'pay' && !!editingTransaction?.nf"
              class="h-11 w-full rounded-lg border border-gray-300 bg-transparent py-2.5 px-4 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
          </div>

          <div class="md:col-span-3">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.costCenter' | translate }}
            </label>
            <div class="relative z-20 bg-transparent">
              <select formControlName="cost_center_id" class="w-full py-2 pl-3 pr-8 text-sm text-gray-800 bg-transparent border border-gray-300 rounded-lg appearance-none h-11 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
                <option value="">{{ 'financial.transactions.form.placeholders.select' | translate }}</option>
                <option *ngFor="let option of costCenterOptions" [value]="option.value">{{ option.text }}</option>
              </select>
              <span class="absolute z-30 text-gray-500 -translate-y-1/2 right-2 top-1/2 dark:text-gray-400">
                 <svg class="stroke-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" /></svg>
              </span>
            </div>
          </div>

          <div class="md:col-span-3">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.category' | translate }}
            </label>
            <div class="relative z-20 bg-transparent">
              <select formControlName="category_id" class="w-full py-2 pl-3 pr-8 text-sm text-gray-800 bg-transparent border border-gray-300 rounded-lg appearance-none h-11 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
                <option value="">{{ 'financial.transactions.form.placeholders.select' | translate }}</option>
                <option *ngFor="let option of categoryOptions" [value]="option.value">{{ option.text }}</option>
              </select>
              <span class="absolute z-30 text-gray-500 -translate-y-1/2 right-2 top-1/2 dark:text-gray-400">
                 <svg class="stroke-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" /></svg>
              </span>
            </div>
          </div>

          <div class="md:col-span-6">
            <app-multi-select
              label="Tag"
              [placeholder]="'financial.transactions.form.placeholders.select' | translate"
              [options]="tagOptions"
              [defaultSelected]="transactionForm.get('tag')?.value"
              [disabled]="transactionForm.get('tag')?.disabled || false"
              (selectionChange)="handleTagSelection($event)">
            </app-multi-select>
          </div>

          <div class="md:col-span-6">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.description' | translate }}
            </label>
            <input type="text" formControlName="description" class="h-11 w-full rounded-lg border border-gray-300 bg-transparent py-2.5 px-4 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100"
              [placeholder]="'financial.transactions.form.placeholders.description' | translate">
          </div>

          <div class="md:col-span-2">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.amount' | translate }}
            </label>
            <input type="number" formControlName="amount" class="dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent py-2.5 px-4 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100"
              [placeholder]="'financial.transactions.form.placeholders.amount' | translate" step="0.01" min="0">
          </div>

          <div class="md:col-span-2">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.dueDate' | translate }}
            </label>
            <div class="relative">
              <input [matDatepicker]="picker" formControlName="due_date" (click)="picker.open()" class="h-11 w-full rounded-lg border border-gray-300 bg-transparent py-2.5 px-4 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
              <mat-datepicker-toggle matIconSuffix [for]="picker" class="absolute right-2 top-1/2 -translate-y-1/2"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
            </div>
          </div>

          <div class="md:col-span-2" *ngIf="transactionForm.get('is_paid')?.value">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{
                transactionForm.get('type')?.value === 'RECEIVABLE'
                  ? ('financial.transactions.form.fields.receivedAt' | translate)
                  : ('financial.transactions.form.fields.paidAt' | translate)
              }}
            </label>
            <div class="relative">
              <input [matDatepicker]="pickerPaid" formControlName="paid_at" (click)="pickerPaid.open()" class="h-11 w-full rounded-lg border border-gray-300 bg-transparent py-2.5 px-4 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
              <mat-datepicker-toggle matIconSuffix [for]="pickerPaid" class="absolute right-2 top-1/2 -translate-y-1/2"></mat-datepicker-toggle>
              <mat-datepicker #pickerPaid></mat-datepicker>
            </div>
          </div>

          <div class="md:col-span-3" *ngIf="transactionForm.get('is_paid')?.value">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.paymentMethod' | translate }}
            </label>
            <div class="relative z-20 bg-transparent">
              <select formControlName="payment_method" class="w-full py-2 pl-3 pr-8 text-sm text-gray-800 bg-transparent border border-gray-300 rounded-lg appearance-none h-11 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
                <option value="">{{ 'financial.transactions.form.placeholders.select' | translate }}</option>
                <option *ngFor="let m of filteredPaymentMethods" [value]="m.value">{{ m.labelKey | translate }}</option>
              </select>
              <span class="absolute z-30 text-gray-500 -translate-y-1/2 right-2 top-1/2 dark:text-gray-400">
                 <svg class="stroke-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" /></svg>
              </span>
            </div>
          </div>

          <div class="md:col-span-3" *ngIf="transactionForm.get('is_paid')?.value && paymentMethodRequiresBank">
            <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
              {{ 'financial.transactions.form.fields.bankAccount' | translate }}
            </label>
            <div class="relative z-20 bg-transparent">
              <select formControlName="bank_account_id" class="w-full py-2 pl-3 pr-8 text-sm text-gray-800 bg-transparent border border-gray-300 rounded-lg appearance-none h-11 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 disabled:bg-brand-50 disabled:text-gray-700 disabled:cursor-not-allowed disabled:opacity-100 dark:disabled:bg-brand-500/15 dark:disabled:text-gray-100">
                <option value="">{{ 'financial.transactions.form.placeholders.select' | translate }}</option>
                <option *ngFor="let acc of filteredBankAccounts" [value]="acc.id">{{ acc.label }}</option>
              </select>
              <span class="absolute z-30 text-gray-500 -translate-y-1/2 right-2 top-1/2 dark:text-gray-400">
                 <svg class="stroke-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" /></svg>
              </span>
            </div>
          </div>
        </div>

        <div class="mt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center gap-2">
             <input type="checkbox" id="is_paid" formControlName="is_paid" class="w-4 h-4 text-brand-500 border-gray-300 rounded focus:ring-brand-500 dark:focus:ring-brand-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600 disabled:bg-brand-50 disabled:border-brand-200 disabled:cursor-not-allowed disabled:opacity-70 dark:disabled:bg-brand-500/15 dark:disabled:border-brand-500">
             <label for="is_paid" class="text-sm font-medium text-gray-700 dark:text-gray-300 cursor-pointer select-none">
               {{
                 transactionForm.get('type')?.value === 'RECEIVABLE'
                   ? ('financial.transactions.formLabels.isPaidReceived' | translate)
                   : ('financial.transactions.formLabels.isPaidPaid' | translate)
               }}
             </label>
          </div>

          <div class="flex items-center gap-2" *ngIf="editingTransaction?.status === 'provisioned'">
            <input type="checkbox" id="effectivate" formControlName="effectivate" class="w-4 h-4 text-brand-500 border-gray-300 rounded focus:ring-brand-500 dark:focus:ring-brand-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
            <label for="effectivate" class="text-sm font-medium text-purple-700 dark:text-purple-400 cursor-pointer select-none">
              Efetivar (Converter para Pendente)
            </label>
          </div>

          <div class="flex items-center gap-4 w-full md:w-auto justify-end">
            <div *ngIf="transactionForm.get('is_paid')?.value && paymentMethodRequiresBank && transactionForm.get('bank_account_id')?.value" class="flex items-center gap-2 text-xs">
              <span class="text-gray-500 dark:text-gray-400">{{ 'financial.bankAccount.table.balance' | translate }}:</span>
              <span
                class="inline-flex items-center rounded-md px-2 py-1 font-medium ring-1 ring-inset"
                [ngClass]="{
                  'bg-green-50 text-green-700 ring-green-600/20 dark:bg-green-500/10 dark:text-green-400 dark:ring-green-500/20': (selectedBankAccountBalance || 0) >= 0,
                  'bg-red-50 text-red-700 ring-red-600/20 dark:bg-red-500/10 dark:text-red-400 dark:ring-red-500/20': (selectedBankAccountBalance || 0) < 0
                }"
              >
                <ng-container *ngIf="selectedBankAccountBalance !== null; else waitingBalance">
                  {{ selectedBankAccountBalance | currency:'BRL' }}
                </ng-container>
                <ng-template #waitingBalance>XXX</ng-template>
              </span>
            </div>

            <button type="submit" [disabled]="transactionForm.invalid && formMode !== 'cancel'" class="flex items-center justify-center rounded-lg bg-brand-500 px-6 py-2 text-center text-sm font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-4 focus:ring-brand-500/50 disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto">
              {{
                formMode === 'pay'
                  ? ('financial.transactions.actions.pay' | translate)
                  : formMode === 'edit'
                  ? ('financial.transactions.actions.update' | translate)
                  : formMode === 'cancel'
                  ? ('financial.transactions.actions.confirmCancel' | translate)
                  : ('financial.transactions.actions.add' | translate)
              }}
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- Card de upload -->
    <div class="rounded-xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03]">
      <h3 class="mb-4 text-lg font-semibold text-gray-800 dark:text-white/90">
        {{ 'financial.evidence.title' | translate }}
      </h3>

      <!-- Existing Files List -->
      <div *ngIf="existingEvidenceFiles.length > 0" class="mb-6 w-full text-left">
        <p class="mb-2 text-xs font-semibold text-gray-600 dark:text-gray-400">
          {{ 'financial.evidence.existingFiles' | translate }}
        </p>
        <div class="rounded-lg border border-gray-200 bg-white text-xs dark:border-gray-800 dark:bg-gray-900">
          <div class="grid grid-cols-[1fr_auto] items-center border-b border-gray-100 px-3 py-2 text-[11px] font-semibold uppercase tracking-wide text-gray-500 dark:border-gray-800 dark:text-gray-400">
            <span>{{ 'financial.evidence.table.name' | translate }}</span>
            <span class="text-right">{{ 'financial.evidence.table.actions' | translate }}</span>
          </div>
          <div class="max-h-40 overflow-y-auto">
            <div *ngFor="let file of existingEvidenceFiles" class="grid grid-cols-[1fr_auto] items-center border-b border-gray-50 px-3 py-2 last:border-b-0 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-white/[0.02] transition-colors">
              <span class="truncate text-gray-700 dark:text-gray-300 cursor-pointer hover:text-brand-500" (click)="viewEvidence(file)" title="{{ file.name }}">
                {{ file.name }}
              </span>
              <div class="flex justify-end">
                <button type="button" class="text-gray-400 hover:text-brand-500 p-1" (click)="viewEvidence(file)" [attr.title]="'financial.evidence.actions.view' | translate">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-4 py-6 text-center dark:border-gray-700 dark:bg-gray-900/40">
        <input type="file" class="hidden" #evidenceInput (change)="onEvidenceFilesSelected($event)" multiple accept=".jpg,.jpeg,.pdf,.txt,.csv">
        <button type="button" class="inline-flex items-center justify-center rounded-md bg-brand-500 px-4 py-2 text-sm font-medium text-white hover:bg-brand-600" (click)="evidenceInput.click()">
          {{ 'financial.evidence.selectFiles' | translate }}
        </button>
        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
          {{ 'financial.evidence.allowedTypes' | translate }}
        </p>

        <div
          *ngIf="evidenceWarningMessage"
          class="mt-3 w-full rounded-lg border border-amber-300 bg-amber-50 px-3 py-2 text-left text-xs text-amber-800 dark:border-amber-500/50 dark:bg-amber-900/30 dark:text-amber-100"
        >
          {{ evidenceWarningMessage }}
        </div>

        <div *ngIf="evidenceFiles.length > 0" class="mt-4 w-full text-left">
          <p class="mb-2 text-xs font-semibold text-gray-600 dark:text-gray-400">
            {{ 'financial.evidence.selectedFiles' | translate }}
          </p>
          <div class="rounded-lg border border-gray-200 bg-white text-xs dark:border-gray-800 dark:bg-gray-900">
            <div class="grid grid-cols-[1fr_auto_auto] items-center border-b border-gray-100 px-3 py-2 text-[11px] font-semibold uppercase tracking-wide text-gray-500 dark:border-gray-800 dark:text-gray-400">
              <span>Nome</span>
              <span></span>
              <span></span>
            </div>
            <div class="max-h-40 overflow-y-auto">
              <div *ngFor="let file of evidenceFiles; let i = index" class="grid grid-cols-[1fr_auto_auto] items-center border-b border-gray-50 px-3 py-2 last:border-b-0 dark:border-gray-800">
                <span class="truncate text-gray-700 dark:text-gray-300">
                  {{ file.name }}
                </span>
                <button type="button" (click)="viewEvidence(file)" class="mx-1 inline-flex h-6 w-6 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-brand-500 dark:text-gray-400 dark:hover:bg-gray-800">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.25 12C3.5 7.75 7.25 5 12 5C16.75 5 20.5 7.75 21.75 12C20.5 16.25 16.75 19 12 19C7.25 19 3.5 16.25 2.25 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button type="button" (click)="removeEvidence(i)" class="mx-1 inline-flex h-6 w-6 items-center justify-center rounded-full text-gray-500 hover:bg-red-50 hover:text-red-600 dark:text-gray-400 dark:hover:bg-red-900/40 dark:hover:text-red-400">
                  <svg class="h-3.5 w-3.5" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3.5 3.5L10.5 10.5M10.5 3.5L3.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card da tabela -->
  <div class="mt-0 rounded-xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
    <!-- Filters Section -->
    <div class="px-4 py-4 border-b border-gray-200 dark:border-gray-800">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:flex-wrap">
        <!-- Type Filter -->
        <div class="w-full sm:w-48">
          <label class="mb-1.5 block text-xs font-medium text-gray-700 dark:text-gray-400">
            Tipo
          </label>
          <app-select
            [options]="typeOptions"
            [value]="typeFilter"
            (valueChange)="onTypeFilterChange($event)"
            placeholder="Todos"
          ></app-select>
        </div>

        <!-- Tag Filter -->
        <div class="w-full sm:w-64">
          <label class="mb-1.5 block text-xs font-medium text-gray-700 dark:text-gray-400">
            Tags
          </label>
          <app-multi-select
            [options]="tagOptions"
            [defaultSelected]="tagFilter"
            (selectionChange)="onTagFilterChange($event)"
            placeholder="Filtrar por tags"
          ></app-multi-select>
        </div>
      </div>
    </div>

    <!-- Search, Pagination and Export -->
    <div class="flex flex-col gap-2 px-4 py-4 border-b border-gray-200 dark:border-gray-800 sm:flex-row sm:items-center sm:justify-between">
      <div class="flex items-center gap-3">
        <span class="text-gray-500 dark:text-gray-400">
          {{ 'financial.transactions.table.pagination.show' | translate }}
        </span>
        <div class="relative z-20 bg-transparent">
          <select
            [(ngModel)]="itemsPerPage"
            (ngModelChange)="onItemsPerPageChange()"
            class="w-full py-2 pl-3 pr-8 text-sm text-gray-800 bg-transparent border border-gray-300 rounded-lg appearance-none h-9 bg-none shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"
          >
            <option [value]="5" class="text-gray-500 dark:bg-gray-900 dark:text-gray-400">5</option>
            <option [value]="10" class="text-gray-500 dark:bg-gray-900 dark:text-gray-400">10</option>
            <option [value]="20" class="text-gray-500 dark:bg-gray-900 dark:text-gray-400">20</option>
            <option [value]="50" class="text-gray-500 dark:bg-gray-900 dark:text-gray-400">50</option>
          </select>
          <span class="absolute z-30 text-gray-500 -translate-y-1/2 right-2 top-1/2 dark:text-gray-400">
            <svg class="stroke-current" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3.8335 5.9165L8.00016 10.0832L12.1668 5.9165" stroke="" strokeWidth="1.2" strokeLinecap="round" strokeLinejoin="round" />
            </svg>
          </span>
        </div>
        <span class="text-gray-500 dark:text-gray-400">
          {{ 'financial.transactions.table.pagination.entries' | translate }}
        </span>
      </div>

      <div class="flex flex-col sm:flex-row gap-3 items-center">
        <!-- Status Filter (Switch Style) -->
        <div class="inline-flex h-11 items-center gap-0.5 rounded-lg bg-gray-100 p-0.5 dark:bg-gray-900">
          <button
            type="button"
            (click)="onStatusFilterChange('all')"
            class="text-theme-sm h-10 rounded-md px-3 py-2 font-medium hover:text-gray-900 dark:hover:text-white"
            [ngClass]="{'shadow-theme-xs text-gray-900 dark:text-white bg-white dark:bg-gray-800': statusFilter === 'all', 'text-gray-500 dark:text-gray-400': statusFilter !== 'all'}">
            {{ 'financial.transactions.filters.all' | translate }}
          </button>
          <button
            type="button"
            (click)="onStatusFilterChange('provisioned')"
            class="text-theme-sm h-10 rounded-md px-3 py-2 font-medium hover:text-gray-900 dark:hover:text-white"
            [ngClass]="{'shadow-theme-xs text-gray-900 dark:text-white bg-white dark:bg-gray-800': statusFilter === 'provisioned', 'text-gray-500 dark:text-gray-400': statusFilter !== 'provisioned'}">
            {{ 'financial.transactions.filters.provisioned' | translate }}
          </button>
          <button
            type="button"
            (click)="onStatusFilterChange('unpaid')"
            class="text-theme-sm h-10 rounded-md px-3 py-2 font-medium hover:text-gray-900 dark:hover:text-white"
            [ngClass]="{'shadow-theme-xs text-gray-900 dark:text-white bg-white dark:bg-gray-800': statusFilter === 'unpaid', 'text-gray-500 dark:text-gray-400': statusFilter !== 'unpaid'}">
            {{ 'financial.transactions.filters.unpaid' | translate }}
          </button>
          <button
            type="button"
            (click)="onStatusFilterChange('paid')"
            class="text-theme-sm h-10 rounded-md px-3 py-2 font-medium hover:text-gray-900 dark:hover:text-white"
            [ngClass]="{'shadow-theme-xs text-gray-900 dark:text-white bg-white dark:bg-gray-800': statusFilter === 'paid', 'text-gray-500 dark:text-gray-400': statusFilter !== 'paid'}">
            {{ 'financial.transactions.filters.paid' | translate }}
          </button>
        </div>

        <!-- Search -->
        <div class="relative w-full sm:w-auto">
          <span class="absolute text-gray-500 -translate-y-1/2 pointer-events-none left-4 top-1/2 dark:text-gray-400">
            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M3.04199 9.37363C3.04199 5.87693 5.87735 3.04199 9.37533 3.04199C12.8733 3.04199 15.7087 5.87693 15.7087 9.37363C15.7087 12.8703 12.8733 15.7053 9.37533 15.7053C5.87735 15.7053 3.04199 12.8703 3.04199 9.37363ZM9.37533 1.54199C5.04926 1.54199 1.54199 5.04817 1.54199 9.37363C1.54199 13.6991 5.04926 17.2053 9.37533 17.2053C11.2676 17.2053 13.0032 16.5344 14.3572 15.4176L17.1773 18.238C17.4702 18.5309 17.945 18.5309 18.2379 18.238C18.5308 17.9451 18.5309 17.4703 18.238 17.1773L15.4182 14.3573C16.5367 13.0033 17.2087 11.2669 17.2087 9.37363C17.2087 5.04817 13.7014 1.54199 9.37533 1.54199Z" fill=""></path>
            </svg>
          </span>
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            [placeholder]="'financial.transactions.table.searchPlaceholder' | translate"
            class="dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent py-2.5 pl-11 pr-4 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800 xl:w-[300px]"
          />
        </div>
        <button
          type="button"
          (click)="exportToCsv()"
          class="shadow-theme-xs flex w-full items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-[11px] text-sm font-medium text-gray-700 sm:w-auto dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M16.6671 13.3333V15.4166C16.6671 16.1069 16.1074 16.6666 15.4171 16.6666H4.58301C3.89265 16.6666 3.33301 16.1069 3.33301 15.4166V13.3333M10.0013 3.33325L10.0013 13.3333M6.14553 7.18708L9.99958 3.33549L13.8539 7.18708" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          {{ 'financial.transactions.actions.exportCsv' | translate }}
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full table-auto">
        <thead>
          <tr class="border-b border-gray-200 dark:divide-gray-800 dark:border-gray-800">
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400 cursor-pointer" (click)="handleSort('type')">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.type' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400 cursor-pointer" (click)="handleSort('nf')">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.nf' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.description' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400 cursor-pointer" (click)="handleSort('amount')">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.amount' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400 cursor-pointer" (click)="handleSort('due_date')">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.dueDate' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.status' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.category' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                {{ 'financial.transactions.table.headers.costCenter' | translate }}
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">
              <span class="text-theme-xs font-medium text-gray-700 dark:text-gray-400">
                Tags
              </span>
            </th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">
              <span class="sr-only">
                {{ 'financial.transactions.table.headers.actions' | translate }}
              </span>
            </th>
          </tr>
        </thead>
        <tbody class="divide-x divide-y divide-gray-200 dark:divide-gray-800">
          <tr *ngFor="let row of paginatedData" class="transition hover:bg-gray-50 dark:hover:bg-gray-900">
            <td class="p-4 whitespace-nowrap">
              <span
                [ngClass]="{
                  'bg-red-50 text-red-600 dark:bg-red-500/10 dark:text-red-500': (row.type || 'PAYABLE') === 'PAYABLE',
                  'bg-blue-50 text-blue-600 dark:bg-blue-500/10 dark:text-blue-500': row.type === 'RECEIVABLE' || row.type === 'TRANSFER',
                  'bg-yellow-50 text-yellow-600 dark:bg-yellow-500/10 dark:text-yellow-500': row.type === 'ADJUSTMENT'
                }"
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
              >
                {{
                  row.type === 'PAYABLE'
                    ? ('financial.transactions.type.payable' | translate)
                    : row.type === 'RECEIVABLE'
                    ? ('financial.transactions.type.receivable' | translate)
                    : row.type === 'TRANSFER'
                    ? ('financial.transactions.type.transfer' | translate)
                    : row.type === 'ADJUSTMENT'
                    ? ('financial.transactions.type.adjustment' | translate)
                    : ('financial.transactions.type.payable' | translate)
                }}
              </span>
            </td>
            <td class="p-4 whitespace-nowrap">
              <span class="text-sm text-gray-700 dark:text-gray-400">{{ row.nf }}</span>
            </td>
            <td class="p-4 min-w-[300px]">
                <span class="text-sm text-gray-700 dark:text-gray-400 block break-words whitespace-normal">
                  {{ row.description }}
                </span>
              </td>
            <td class="p-4 whitespace-nowrap">
              <span class="text-sm text-gray-700 dark:text-gray-400">
                {{ row.amount | currency:'BRL':'symbol':'1.2-2' }}
              </span>
            </td>
            <td class="p-4 whitespace-nowrap">
              <span
                class="text-sm text-gray-700 dark:text-gray-400"
                [ngClass]="{
                  'font-semibold text-yellow-600 dark:text-yellow-400': isDelayed(row)
                }"
              >
                {{ row.due_date | date:'shortDate' }}
              </span>
            </td>
            <td class="p-4 whitespace-nowrap">
              <span
                class="inline-flex items-center gap-1 rounded-full px-2 text-xs font-semibold leading-5"
                [ngClass]="{
                  'bg-green-100 text-green-800 dark:bg-green-800/30 dark:text-green-400': row.status === 'paid',
                  'bg-yellow-100 text-yellow-800 dark:bg-yellow-800/30 dark:text-yellow-400': row.status === 'pending' || row.status === 'scheduled' || row.status === 'approved',
                  'bg-red-100 text-red-800 dark:bg-red-800/30 dark:text-red-400': row.status === 'overdue' || row.status === 'canceled',
                  'bg-purple-100 text-purple-800 dark:bg-purple-800/30 dark:text-purple-400': row.status === 'provisioned'
                }"
              >
                <svg
                  *ngIf="isDelayed(row)"
                  class="h-3.5 w-3.5 text-yellow-500"
                  viewBox="0 0 20 20"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M10 2.5C6.41015 2.5 3.5 5.41015 3.5 9C3.5 12.5899 6.41015 15.5 10 15.5C13.5899 15.5 16.5 12.5899 16.5 9C16.5 5.41015 13.5899 2.5 10 2.5Z"
                    stroke="currentColor"
                    stroke-width="1.5"
                  />
                  <path
                    d="M10 5.5V9.25L12.25 10.5"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
                <span>{{ getStatusLabel(row.status) }}</span>
              </span>
            </td>
            <td class="p-4 whitespace-nowrap">
              <span class="text-sm text-gray-700 dark:text-gray-400">{{ row.category_data?.name || row.category }}</span>
            </td>
            <td class="p-4 whitespace-nowrap">
              <span class="text-sm text-gray-700 dark:text-gray-400">{{ row.cost_center_data?.name || row.cost_center }}</span>
            </td>
            <td class="p-4 whitespace-nowrap">
              <div class="flex flex-wrap gap-1">
                <span *ngFor="let tag of row.tags"
                      class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium text-white"
                      [style.backgroundColor]="tag.color">
                  {{ tag.name }}
                </span>
              </div>
            </td>
            <td class="p-4 whitespace-nowrap">
              <div class="flex items-center gap-2 justify-end">
                <app-popover *ngIf="row.status !== 'canceled'" #rowActionsPopover="appPopover" position="left">
                  <ng-template #popoverTrigger>
                    <button
                      type="button"
                      class="inline-flex h-8 w-8 items-center justify-center rounded-full border border-gray-200 bg-white text-gray-600 hover:text-gray-800 dark:border-gray-800 dark:bg-gray-700 dark:text-gray-300"
                    >
                      <svg class="size-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 12.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" fill="currentColor"/>
                        <path d="M12 6.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" fill="currentColor"/>
                        <path d="M12 18.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" fill="currentColor"/>
                      </svg>
                    </button>
                  </ng-template>
                  <ng-template #popoverContent>
                    <div class="w-full space-y-1 p-2">
                      <button
                        *ngIf="canEdit(row)"
                        type="button"
                        (click)="onSelectRowAction($event, row, 'edit'); rowActionsPopover.close()"
                        class="flex w-full px-2 py-1.5 text-left text-xs font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-800 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-gray-100"
                      >
                        {{ 'financial.transactions.actions.edit' | translate }}
                      </button>
                      <button
                        *ngIf="canPay(row)"
                        type="button"
                        (click)="onSelectRowAction($event, row, 'pay'); rowActionsPopover.close()"
                        class="flex w-full px-2 py-1.5 text-left text-xs font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-800 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-gray-100"
                      >
                        {{ 'financial.transactions.actions.pay' | translate }}
                      </button>
                      <button
                        *ngIf="canCancel(row)"
                        type="button"
                        (click)="onSelectRowAction($event, row, 'cancel'); rowActionsPopover.close()"
                        class="flex w-full px-2 py-1.5 text-left text-xs font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-800 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-gray-100"
                      >
                        {{ 'financial.transactions.actions.cancel' | translate }}
                      </button>
                      <button
                        *ngIf="canDelete(row)"
                        type="button"
                        (click)="onSelectRowAction($event, row, 'delete'); rowActionsPopover.close()"
                        class="flex w-full px-2 py-1.5 text-left text-xs font-medium text-gray-600 rounded-lg hover:bg-gray-100 hover:text-gray-800 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-gray-100"
                      >
                        {{ 'financial.transactions.actions.delete' | translate }}
                      </button>
                    </div>
                  </ng-template>
                </app-popover>
                <button
                  type="button"
                  (click)="openEvidenceSidebar(row)"
                  class="inline-flex h-8 w-8 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-brand-500 dark:text-gray-400 dark:hover:bg-gray-800"
                >
                  <svg class="fill-current" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13.7535 2.47502H11.5879V1.9969C11.5879 1.15315 10.9129 0.487524 10.0317 0.487524H7.90672C7.02547 0.487524 6.35047 1.15315 6.35047 1.9969V2.47502H4.18484C3.25672 2.47502 2.47859 3.26252 2.47859 4.2094V14.4563C2.47859 15.4032 3.25672 16.1906 4.18484 16.1906H13.7535C14.6817 16.1906 15.4598 15.4032 15.4598 14.4563V4.2094C15.4598 3.26252 14.6817 2.47502 13.7535 2.47502ZM7.90672 1.9969H10.0317V2.47502H7.90672V1.9969ZM13.7535 14.4563H4.18484V4.2094H13.7535V14.4563Z" fill=""/>
                    <path d="M12.1289 6.99375H5.80938C5.5375 6.99375 5.31562 7.21563 5.31562 7.4875C5.31562 7.75938 5.5375 7.98125 5.80938 7.98125H12.1289C12.4008 7.98125 12.6227 7.75938 12.6227 7.4875C12.6227 7.21563 12.4008 6.99375 12.1289 6.99375Z" fill=""/>
                    <path d="M12.1289 10.2938H5.80938C5.5375 10.2938 5.31562 10.5156 5.31562 10.7875C5.31562 11.0594 5.5375 11.2813 5.80938 11.2813H12.1289C12.4008 11.2813 12.6227 11.0594 12.6227 10.7875C12.6227 10.5156 12.4008 10.2938 12.1289 10.2938Z" fill=""/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="flex items-center flex-col sm:flex-row justify-between border-t border-gray-200 px-5 py-4 dark:border-gray-800">
      <div class="pb-3 sm:pb-0">
        <span class="block text-sm font-medium text-gray-500 dark:text-gray-400">
          Showing <span class="text-gray-800 dark:text-white/90">{{ (currentPage - 1) * itemsPerPage + 1 }}</span>
          to
          <span class="text-gray-800 dark:text-white/90">{{ Math.min(currentPage * itemsPerPage, totalItems) }}</span>
          of
          <span class="text-gray-800 dark:text-white/90">{{ totalItems }}</span>
        </span>
      </div>
      <div class="flex items-center justify-between p-4 sm:p-0 rounded-lg w-full sm:w-auto bg-gray-50 dark:bg-white/[0.03] dark:sm:bg-transparent sm:bg-transparent gap-2 sm:justify-normal">
        <button
          class="shadow-theme-xs flex items-center gap-2 rounded-lg border border-gray-300 bg-white p-2 text-gray-700 hover:bg-gray-50 hover:text-gray-800 sm:p-2.5 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] dark:hover:text-gray-200"
          [ngClass]="{'opacity-50 cursor-not-allowed': currentPage === 1}"
          (click)="onPageChange(currentPage - 1)"
          [disabled]="currentPage === 1">
          <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M2.58203 9.99868C2.58174 10.1909 2.6549 10.3833 2.80152 10.53L7.79818 15.5301C8.09097 15.8231 8.56584 15.8233 8.85883 15.5305C9.15183 15.2377 9.152 14.7629 8.85921 14.4699L5.13911 10.7472L16.6665 10.7472C17.0807 10.7472 17.4165 10.4114 17.4165 9.99715C17.4165 9.58294 17.0807 9.24715 16.6665 9.24715L5.14456 9.24715L8.85919 5.53016C9.15199 5.23717 9.15184 4.7623 8.85885 4.4695C8.56587 4.1767 8.09099 4.17685 7.79819 4.46984L2.84069 9.43049C2.68224 9.568 2.58203 9.77087 2.58203 9.99715C2.58203 9.99766 2.58203 9.99817 2.58203 9.99868Z" fill=""></path>
          </svg>
        </button>
        <span class="block text-sm font-medium text-gray-700 sm:hidden dark:text-gray-400">
          Page {{currentPage}} of {{totalPages}}
        </span>
        <ul class="hidden items-center gap-0.5 sm:flex">
          <li *ngFor="let page of visiblePages">
            <button
              (click)="onPageChange(page)"
              class="flex h-10 w-10 items-center justify-center rounded-lg text-sm font-medium"
              [ngClass]="{'bg-brand-500 text-white': page === currentPage, 'hover:bg-brand-500 text-gray-700 hover:text-white dark:text-gray-400 dark:hover:text-white': page !== currentPage}">
              {{page}}
            </button>
          </li>
        </ul>
        <button
          class="shadow-theme-xs flex items-center gap-2 rounded-lg border border-gray-300 bg-white p-2 text-gray-700 hover:bg-gray-50 hover:text-gray-800 sm:p-2.5 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] dark:hover:text-gray-200"
          [ngClass]="{'opacity-50 cursor-not-allowed': currentPage === totalPages}"
          (click)="onPageChange(currentPage + 1)"
          [disabled]="currentPage === totalPages">
          <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M17.4165 9.9986C17.4168 10.1909 17.3437 10.3832 17.197 10.53L12.2004 15.5301C11.9076 15.8231 11.4327 15.8233 11.1397 15.5305C10.8467 15.2377 10.8465 14.7629 11.1393 14.4699L14.8594 10.7472L3.33203 10.7472C2.91782 10.7472 2.58203 10.4114 2.58203 9.99715C2.58203 9.58294 2.91782 9.24715 3.33203 9.24715L14.854 9.24715L11.1393 5.53016C10.8465 5.23717 10.8467 4.7623 11.1397 4.4695C11.4327 4.1767 11.9075 4.17685 12.2003 4.46984L17.1578 9.43049C17.3163 9.568 17.4165 9.77087 17.4165 9.99715C17.4165 9.99763 17.4165 9.99812 17.4165 9.9986Z" fill=""></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <div
    *ngIf="isEvidenceSidebarOpen"
    class="fixed inset-0 z-[100000] bg-gray-900/40"
    (click)="closeEvidenceSidebar()"
  ></div>

  <aside
    *ngIf="isEvidenceSidebarOpen"
    class="fixed top-0 right-0 z-[100001] flex h-screen w-full max-w-md flex-col border-l border-gray-200 bg-white shadow-theme-lg dark:border-gray-800 dark:bg-gray-900"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between border-b border-gray-200 px-5 py-4 dark:border-gray-800">
      <div>
        <p class="text-xs font-medium uppercase tracking-wide text-gray-400 dark:text-gray-500">
          {{ 'financial.transactions.offcanvas.subtitle' | translate }}
        </p>
        <h3 class="mt-1 text-base font-semibold text-gray-800 dark:text-white/90">
          {{ selectedTransaction?.description || ('financial.transactions.offcanvas.titleFallback' | translate) }}
        </h3>
      </div>
      <button
        type="button"
        (click)="closeEvidenceSidebar()"
        class="inline-flex h-8 w-8 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-800 dark:text-gray-400 dark:hover:bg-gray-800"
      >
        <svg class="h-4 w-4" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.5 3.5L10.5 10.5M10.5 3.5L3.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

        <div class="flex-1 overflow-y-auto px-5 py-4 space-y-6">
          <div class="space-y-3">
            <div class="flex flex-wrap items-center gap-2">
              <span
                *ngIf="selectedTransaction?.type"
                [ngClass]="{
                  'bg-red-50 text-red-600 dark:bg-red-500/10 dark:text-red-500': (selectedTransaction?.type || 'PAYABLE') === 'PAYABLE',
                  'bg-blue-50 text-blue-600 dark:bg-blue-500/10 dark:text-blue-500': selectedTransaction?.type === 'RECEIVABLE' || selectedTransaction?.type === 'TRANSFER',
                  'bg-yellow-50 text-yellow-600 dark:bg-yellow-500/10 dark:text-yellow-500': selectedTransaction?.type === 'ADJUSTMENT'
                }"
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
              >
            {{ selectedTransaction?.type === 'PAYABLE' ? 'Pagar' : 
               selectedTransaction?.type === 'RECEIVABLE' ? 'Receber' :
               selectedTransaction?.type === 'TRANSFER' ? 'Transferência' :
               selectedTransaction?.type === 'ADJUSTMENT' ? 'Ajuste' : 'Pagar' }}
          </span>

          <span
            *ngIf="selectedTransaction?.status"
            class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold"
            [ngClass]="{
              'bg-green-100 text-green-800 dark:bg-green-800/30 dark:text-green-400': selectedTransaction?.status === 'paid',
              'bg-yellow-100 text-yellow-800 dark:bg-yellow-800/30 dark:text-yellow-400': selectedTransaction?.status === 'pending' || selectedTransaction?.status === 'scheduled' || selectedTransaction?.status === 'approved',
              'bg-red-100 text-red-800 dark:bg-red-800/30 dark:text-red-400': selectedTransaction?.status === 'overdue' || selectedTransaction?.status === 'canceled'
            }"
          >
            {{ selectedTransaction?.status }}
          </span>
        </div>

        <dl class="grid grid-cols-1 gap-y-2 text-sm text-gray-600 dark:text-gray-300">
          <div class="flex items-center justify-between gap-4">
            <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">
              {{ 'financial.transactions.offcanvas.fields.nf' | translate }}
            </dt>
            <dd class="text-sm text-gray-800 dark:text-white/90 truncate max-w-[220px]">
              {{ selectedTransaction?.nf || '-' }}
            </dd>
          </div>
          <div class="flex items-center justify-between gap-4">
            <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">
              {{ 'financial.transactions.offcanvas.fields.amount' | translate }}
            </dt>
            <dd class="text-sm text-gray-800 dark:text-white/90">
              {{ selectedTransaction?.amount | currency:'BRL':'symbol':'1.2-2':'pt' }}
            </dd>
          </div>
          <div class="flex items-center justify-between gap-4">
            <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">
              {{ 'financial.transactions.offcanvas.fields.dueDate' | translate }}
            </dt>
            <dd class="text-sm text-gray-800 dark:text-white/90">
              {{ selectedTransaction?.due_date | date:'shortDate' }}
            </dd>
          </div>
          <div class="flex items-center justify-between gap-4">
            <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">
              {{ 'financial.transactions.offcanvas.fields.category' | translate }}
            </dt>
            <dd class="text-sm text-gray-800 dark:text-white/90 truncate max-w-[220px]">
              {{ selectedTransaction?.category || '-' }}
            </dd>
          </div>
          <div class="flex items-center justify-between gap-4">
            <dt class="text-xs font-medium text-gray-500 dark:text-gray-400">
              {{ 'financial.transactions.offcanvas.fields.costCenter' | translate }}
            </dt>
            <dd class="text-sm text-gray-800 dark:text-white/90 truncate max-w-[220px]">
              {{ selectedTransaction?.cost_center || '-' }}
            </dd>
          </div>
        </dl>
      </div>

      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <h4 class="text-sm font-semibold text-gray-800 dark:text-white/90">
            {{ 'financial.evidence.title' | translate }}
          </h4>
        </div>

        <ng-container *ngIf="selectedEvidenceItems.length > 0; else noEvidence">
          <div class="space-y-2">
            <div
              *ngFor="let item of selectedEvidenceItems"
              class="flex items-center gap-3 rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 dark:border-gray-800 dark:bg-gray-900"
            >
              <div class="flex h-10 w-10 items-center justify-center overflow-hidden rounded-md bg-gray-200 dark:bg-gray-800">
                <img
                  *ngIf="item.type === 'image' && item.url"
                  [src]="item.url"
                  alt="Evidência"
                  class="h-full w-full object-cover"
                />
                <span *ngIf="item.type !== 'image'" class="text-xs font-semibold uppercase text-gray-700 dark:text-gray-200">
                  {{ item.extension || 'ARQ' }}
                </span>
              </div>
              <div class="min-w-0 flex-1">
                <p class="truncate text-xs font-medium text-gray-800 dark:text-white/90">
                  {{ item.name }}
                </p>
                <p class="text-[11px] text-gray-500 dark:text-gray-400">
                  {{ item.type === 'pdf' ? 'PDF' : (item.type === 'image' ? 'Imagem' : 'Arquivo') }}
                </p>
              </div>
              <button
                type="button"
                class="inline-flex h-7 w-7 items-center justify-center rounded-full text-gray-500 hover:bg-gray-100 hover:text-brand-500 dark:text-gray-400 dark:hover:bg-gray-800"
                (click)="openEvidenceItem(item)"
              >
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M2.25 12C3.5 7.75 7.25 5 12 5C16.75 5 20.5 7.75 21.75 12C20.5 16.25 16.75 19 12 19C7.25 19 3.5 16.25 2.25 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
        </ng-container>

        <ng-template #noEvidence>
          <div class="rounded-lg border border-dashed border-gray-300 bg-gray-50 px-4 py-3 text-xs text-gray-500 dark:border-gray-700 dark:bg-gray-900/40 dark:text-gray-400">
            {{ 'financial.evidence.noEvidence' | translate }}
          </div>
        </ng-template>
      </div>
    </div>
  </aside>

  <app-modal
    [isOpen]="isDeleteModalOpen"
    (close)="closeDeleteModal()"
    className="max-w-[600px] p-5 lg:p-10"
  >
    <div class="text-center">
      <div class="relative flex items-center justify-center z-1 mb-7">
        <svg
          class="fill-error-50 dark:fill-error-500/15"
          width="90"
          height="90"
          viewBox="0 0 90 90"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M34.364 6.85053C38.6205 -2.28351 51.3795 -2.28351 55.636 6.85053C58.0129 11.951 63.5594 14.6722 68.9556 13.3853C78.6192 11.0807 86.5743 21.2433 82.2185 30.3287C79.7862 35.402 81.1561 41.5165 85.5082 45.0122C93.3019 51.2725 90.4628 63.9451 80.7747 66.1403C75.3648 67.3661 71.5265 72.2695 71.5572 77.9156C71.6123 88.0265 60.1169 93.6664 52.3918 87.3184C48.0781 83.7737 41.9219 83.7737 37.6082 87.3184C29.8831 93.6664 18.3877 88.0266 18.4428 77.9156C18.4735 72.2695 14.6352 67.3661 9.22531 66.1403C-0.462787 63.9451 -3.30193 51.2725 4.49185 45.0122C8.84391 41.5165 10.2138 35.402 7.78151 30.3287C3.42572 21.2433 11.3808 11.0807 21.0444 13.3853C26.4406 14.6722 31.9871 11.951 34.364 6.85053Z"
            fill=""
            fill-opacity=""
          />
        </svg>

        <span
          class="absolute -translate-x-1/2 -translate-y-1/2 left-1/2 top-1/2"
        >
          <svg
            class="fill-error-600 dark:fill-error-500"
            width="38"
            height="38"
            viewBox="0 0 38 38"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              d="M9.62684 11.7496C9.04105 11.1638 9.04105 10.2141 9.62684 9.6283C10.2126 9.04252 11.1624 9.04252 11.7482 9.6283L18.9985 16.8786L26.2485 9.62851C26.8343 9.04273 27.7841 9.04273 28.3699 9.62851C28.9556 10.2143 28.9556 11.164 28.3699 11.7498L21.1198 18.9999L28.3699 26.25C28.9556 26.8358 28.9556 27.7855 28.3699 28.3713C27.7841 28.9571 26.8343 28.9571 26.2485 28.3713L18.9985 21.1212L11.7482 28.3715C11.1624 28.9573 10.2126 28.9573 9.62684 28.3715C9.04105 27.7857 9.04105 26.836 9.62684 26.2502L16.8771 18.9999L9.62684 11.7496Z"
              fill=""
            />
          </svg>
        </span>
      </div>

      <h4 class="mb-2 text-2xl font-semibold text-gray-800 dark:text-white/90 sm:text-title-sm">
        {{ 'financial.transactions.deleteModal.title' | translate }}
      </h4>
      <p class="text-sm leading-6 text-gray-500 dark:text-gray-400">
        {{ 'financial.transactions.deleteModal.message' | translate }}
      </p>
      <p
        *ngIf="transactionToDelete"
        class="mt-4 text-sm text-gray-700 dark:text-gray-300"
      >
        <span class="font-medium">
          {{ 'financial.transactions.deleteModal.transactionLabel' | translate }}
        </span>
        <span class="ml-1">
          {{ transactionToDelete.description || transactionToDelete.id_code }}
        </span>
      </p>
      <div class="flex items-center justify-center w-full gap-3 mt-7">
        <button
          type="button"
          class="flex justify-center w-full px-4 py-3 text-sm font-medium text-gray-700 rounded-lg bg-white ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:text-gray-300 dark:ring-gray-700 dark:hover:bg-white/[0.03] sm:w-auto"
          (click)="closeDeleteModal()"
        >
          {{ 'financial.transactions.actions.cancel' | translate }}
        </button>
        <button
          type="button"
          class="flex justify-center w-full px-4 py-3 text-sm font-medium text-white rounded-lg bg-error-500 shadow-theme-xs hover:bg-error-600 sm:w-auto"
          (click)="confirmDelete()"
        >
          {{ 'financial.transactions.actions.confirmDelete' | translate }}
        </button>
      </div>
    </div>
  </app-modal>
</div>
