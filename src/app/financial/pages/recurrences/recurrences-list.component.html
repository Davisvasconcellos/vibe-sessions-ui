<div class="flex flex-col gap-5">
  <!-- Header -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h2 class="text-xl font-bold text-gray-900 dark:text-white">
        Recorrências
      </h2>
      <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
        Gerencie suas contas recorrentes e gere lançamentos automáticos.
      </p>
    </div>
    <div class="flex gap-2">
      <button
        (click)="openGenerateModal()"
        class="inline-flex items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"
      >
        <span>Gerar Contas</span>
      </button>
      <button
        (click)="toggleForm()"
        class="inline-flex items-center justify-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 focus:outline-none focus:ring-4 focus:ring-brand-500/25"
      >
        <svg
          *ngIf="!isFormVisible"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        <svg
          *ngIf="isFormVisible"
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        <span>{{ isFormVisible ? 'Cancelar' : 'Nova Recorrência' }}</span>
      </button>
    </div>
  </div>

  <!-- Inline Form -->
  <div *ngIf="isFormVisible" class="rounded-xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03]">
    <h3 class="mb-4 text-lg font-semibold text-gray-800 dark:text-white/90">
      {{ editingRecurrence ? 'Editar Recorrência' : 'Nova Recorrência' }}
    </h3>
    <app-recurrences-form
      [recurrence]="editingRecurrence"
      (save)="onFormSave()"
      (cancel)="onFormCancel()"
    ></app-recurrences-form>
  </div>

  <!-- Table -->
  <div class="rounded-xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03]">
    <div class="overflow-x-auto">
      <table class="w-full table-auto">
        <thead>
          <tr class="border-b border-gray-200 dark:divide-gray-800 dark:border-gray-800">
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">Descrição</th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">Tipo</th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">Valor</th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">Frequência</th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">Dia Venc.</th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">Status</th>
            <th class="p-4 text-left text-xs font-medium text-gray-700 dark:text-gray-400">Ações</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-800">
          <tr *ngFor="let item of recurrences" 
              class="hover:bg-gray-50 dark:hover:bg-gray-900/50 transition-colors"
              [ngClass]="{'bg-red-50 dark:bg-red-900/20': item.status === 'paused'}">
            <td class="p-4 text-sm text-gray-900 dark:text-white">{{ item.description }}</td>
            <td class="p-4 text-sm">
              <span
                class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium"
                [ngClass]="{
                  'bg-red-50 text-red-700 dark:bg-red-500/10 dark:text-red-400': item.type === 'PAYABLE',
                  'bg-green-50 text-green-700 dark:bg-green-500/10 dark:text-green-400': item.type === 'RECEIVABLE',
                  'bg-blue-50 text-blue-700 dark:bg-blue-500/10 dark:text-blue-400': item.type === 'TRANSFER'
                }"
              >
                {{ item.type === 'PAYABLE' ? 'A Pagar' : item.type === 'RECEIVABLE' ? 'A Receber' : 'Transferência' }}
              </span>
            </td>
            <td class="p-4 text-sm text-gray-900 dark:text-white">{{ item.amount | currency:'BRL' }}</td>
            <td class="p-4 text-sm text-gray-500 dark:text-gray-400">{{ getFrequencyLabel(item.frequency) }}</td>
            <td class="p-4 text-sm text-gray-500 dark:text-gray-400">{{ item.day_of_month }}</td>
            <td class="p-4 text-sm">
              <span
                class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium"
                [ngClass]="{
                  'bg-green-50 text-green-700 dark:bg-green-500/10 dark:text-green-400': item.status === 'active',
                  'bg-yellow-50 text-yellow-700 dark:bg-yellow-500/10 dark:text-yellow-400': item.status === 'paused',
                  'bg-gray-50 text-gray-700 dark:bg-gray-500/10 dark:text-gray-400': item.status === 'finished'
                }"
              >
                {{ getStatusLabel(item.status) }}
              </span>
            </td>
            <td class="p-4 text-sm">
              <div class="flex items-center gap-2">
                <!-- Play/Pause Button -->
                <button 
                  *ngIf="item.status !== 'finished'"
                  (click)="toggleStatus(item)" 
                  class="p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                  [ngClass]="item.status === 'active' ? 'text-amber-500 hover:text-amber-600' : 'text-green-500 hover:text-green-600'"
                  [title]="item.status === 'active' ? 'Pausar' : 'Ativar'"
                >
                  <!-- Pause Icon -->
                  <svg *ngIf="item.status === 'active'" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="6" y="4" width="4" height="16"></rect>
                    <rect x="14" y="4" width="4" height="16"></rect>
                  </svg>
                  <!-- Play Icon -->
                  <svg *ngIf="item.status === 'paused'" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                  </svg>
                </button>

                <!-- Edit Button -->
                <button (click)="editRecurrence(item)" class="p-1.5 text-gray-500 hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-800 rounded-md transition-colors" title="Editar">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>

                <!-- Delete Button -->
                <button (click)="deleteRecurrence(item)" class="p-1.5 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors" title="Excluir">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="recurrences.length === 0">
            <td colspan="7" class="p-8 text-center text-gray-500 dark:text-gray-400">
              Nenhuma recorrência encontrada.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Generate Modal -->
<app-modal
  [isOpen]="isGenerateModalOpen"
  (closeModal)="isGenerateModalOpen = false"
  title="Gerar Contas"
>
  <div class="space-y-4">
    <p class="text-sm text-gray-500 dark:text-gray-400">
      Selecione a data de referência para gerar as contas recorrentes.
      As contas serão geradas com base nas regras ativas.
    </p>
    
    <div>
      <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
        Data de Referência (Mês/Ano)
      </label>
      <input
        type="date"
        [(ngModel)]="generationDate"
        class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300 focus:outline-none focus:ring focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"
      />
    </div>

    <div class="flex justify-end gap-3 pt-4">
      <button
        (click)="isGenerateModalOpen = false"
        class="rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"
      >
        Cancelar
      </button>
      <button
        (click)="confirmGeneration()"
        class="rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600"
      >
        Confirmar Geração
      </button>
    </div>
  </div>
</app-modal>
